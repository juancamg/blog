---
title: "D√≠a 2 - Calendario de Adviento TryHackMe 2024"
description: "En esta publicaci√≥n resolvemos el reto del d√≠a 2 en el Advent of Cyber 2024 organizado por TryHackMe."
image: "/images/blog/advent-of-cyber-2024/thumbnails/day2.png"
date: "2024-12-02"
author: "xhetic"
tag: ["TryHackMe", "Principiante", "OPSEC", "Advent of Cyber"]
category: "Writeups"
featured: false
---

# Calendario de Adviento TryHackMe 2024 - D√≠a 2 üéÑüîç

---

## üïµÔ∏è Historia: ¬øQui√©n est√° detr√°s del caos?

Es diciembre, y el equipo del SOC de Wareville est√° al borde del colapso. Las alertas no dejan de llegar, y los analistas est√°n exhaustos tratando de diferenciar entre actividades leg√≠timas y posibles ataques. Una alerta enviada por la oficina del alcalde indica m√∫ltiples comandos PowerShell codificados ejecutados en sus sistemas el 1 de diciembre. La sospecha recae en el infame **Mayor Malware**, pero ¬øes todo lo que parece? 

¬øPodr√°s ayudar al SOC a investigar este incidente y revelar la verdad detr√°s de estas actividades sospechosas?

---

## üéØ Objetivos de aprendizaje

En este desaf√≠o aprenderemos a:

1. Diferenciar entre *True Positives* (TP) y *False Positives* (FP).
2. Usar herramientas de monitoreo para analizar eventos en un marco de tiempo espec√≠fico.
3. Aplicar filtros y correlaciones para rastrear patrones sospechosos.
4. Decodificar comandos PowerShell codificados para entender su prop√≥sito.
5. Construir un caso basado en evidencia para determinar si alguien es un h√©roe o un villano.

---

## üõ†Ô∏è Paso a paso: Resolviendo el reto

### Paso 1: Conecta la m√°quina y accede a la interfaz

1. Activa la m√°quina virtual proporcionada en la sala de TryHackMe.
2. Ingresa a la plataforma web usando las credenciales dadas.
3. Haz clic en el men√∫ (arriba a la izquierda) y selecciona **Discover**.

![Sitio web](/images/blog/advent-of-cyber-2024/day2-img1.png)

---

### Paso 2: Configura el marco de tiempo y a√±ade columnas clave

1. Ajusta el marco de tiempo al rango **1 de diciembre de 2024, 09:00 a 09:30**:  
   - Haz clic en el selector de tiempo (arriba a la derecha).  
   - Selecciona la pesta√±a **Absolute** y configura las fechas y horas exactas.  
   - Pulsa **Update** para aplicar los cambios.

Esto mostrar√° 21 eventos en ese marco de tiempo.

2. Para analizar los eventos, a√±ade las siguientes columnas desde el panel izquierdo:  
   - **host.hostname**: Identifica las m√°quinas afectadas.  
   - **user.name**: Muestra qu√© usuario ejecut√≥ las acciones.  
   - **event.category**: Clasifica los eventos por tipo.  
   - **process.command_line**: Detalla los comandos ejecutados.  
   - **event.outcome**: Indica si la acci√≥n fue exitosa o fallida.

Con estas columnas a√±adidas, los eventos se presentan de forma m√°s clara, revelando actividades sospechosas de PowerShell en varias m√°quinas.

![Columnas clave](/images/blog/advent-of-cyber-2024/day2-img2.png)

---

### Paso 3: Recopilando y rastreando informaci√≥n

Al observar los eventos, notamos un patr√≥n interesante: la actividad de PowerShell ocurre en diferentes m√°quinas, y el tiempo entre los intentos de autenticaci√≥n exitosos y los comandos de PowerShell es muy preciso. Esto genera sospechas, ya que las mejores pr√°cticas sugieren que se utilicen cuentas personales para actividades administrativas, lo que permite atribuci√≥n y responsabilidad claras. Sin embargo, en este caso, una cuenta gen√©rica de administrador fue utilizada, algo que no es ideal. Los analistas nos confirmaron que esta cuenta es usada por dos administradores que **no estaban en la oficina durante este periodo**. Esto aumenta las sospechas de que algo est√° mal.

Para continuar nuestra investigaci√≥n, a√±adiremos la columna **source.ip** para identificar la direcci√≥n IP responsable de ejecutar los comandos PowerShell. Sin embargo, como este campo solo aparece en eventos de autenticaci√≥n, filtraremos estos eventos para buscar un patr√≥n. Para hacerlo:  

1. Filtra `event.category` = authentication.

Al analizar los resultados no vemos ninguna informaci√≥n √∫til, por lo que quitamos este filtro que acabamos de poner.

Dado que los eventos de autenticaci√≥n pueden haber ocurrido antes del marco de tiempo original, expandimos nuestra b√∫squeda para incluir eventos desde el **29 de noviembre hasta el 1 de diciembre de 2024**. Al hacerlo:  
- Encontramos **m√°s de 6800 eventos** en este periodo.  
- Observamos un pico significativo al final del registro de eventos, pero no hay m√°s actividad despu√©s de la ejecuci√≥n exitosa de PowerShell.

Para reducir a√∫n m√°s la b√∫squeda, aplicamos los filtros:  
- **user.name: service_admin**  
- **source.ip: 10.0.11.11**  

![Resultado](/images/blog/advent-of-cyber-2024/day2-img5.png)

Esto nos muestra que todos los eventos provienen de la misma cuenta y direcci√≥n IP. Sin embargo, este patr√≥n a√∫n no explica el pico en los eventos. Para investigar m√°s:  
1. Filtramos eventos de autenticaci√≥n nuevamente.  
2. Excluimos la direcci√≥n IP (10.0.11.11) seleccionando el signo ‚Äú-‚Äù junto a ella.

Los resultados nos muestran que los eventos fallidos de autenticaci√≥n aumentan notablemente, vinculados a una nueva direcci√≥n IP (terminada en .255.1).  

Eliminamos el filtro de direcci√≥n IP para concentrarnos en los eventos de autenticaci√≥n cercanos al pico. 

Al revisar los registros, vemos que los intentos de inicio de sesi√≥n fallidos cesaron poco despu√©s de un inicio de sesi√≥n exitoso desde la nueva direcci√≥n IP.  


Habiendo analizado todo esto podemos llegar a la conclusi√≥n preliminar de que alguien parece haber realizado un ataque de fuerza bruta el **1 de diciembre de 2024**, logrando un inicio de sesi√≥n exitoso y ejecutando r√°pidamente comandos PowerShell en las m√°quinas afectadas. Una vez ejecutados los comandos, no hubo m√°s intentos de inicio de sesi√≥n. Esto claramente apunta a un **True Positive (TP)**, y es momento de escalar el incidente para que **McSkidy** nos ayude a responder ante esta amenaza.

---

### Paso 4: Confirmando el ataque y decodificando el comando 

Ahora que sabemos que los comandos de PowerShell fueron ejecutados tras una autenticaci√≥n exitosa, necesitamos analizar exactamente qu√© hicieron. En este caso, el comando est√° codificado, por lo que no podemos interpretarlo directamente.

1. **Revisar los detalles del comando codificado:**  
   Miramos el campo `process.command_line` para encontrar la l√≠nea de comando completa ejecutada por PowerShell. Vemos que el comando est√° codificado en Base64.

2. **Decodificar el comando Base64:**  
   Usamos un decodificador como **[CyberChef](https://gchq.github.io/CyberChef/)** para traducir el texto codificado. Dado que PowerShell usa codificaci√≥n `UTF-16LE` por defecto, configuramos esta opci√≥n en la herramienta para obtener resultados precisos.

3. **Analizar el resultado decodificado:**  
   Una vez decodificado, el comando revela que se ejecut√≥ un comando para actualizar el sistema operativo mostrando que este comando no es malicioso.

---

## ü¶∏ Reflexi√≥n: ¬øH√©roe o villano?

El an√°lisis revela que **Glitch**, inicialmente sospechoso, no solo accedi√≥ al sistema mediante fuerza bruta, sino que tambi√©n solucion√≥ un problema cr√≠tico actualizando credenciales caducadas. Esto plantea una pregunta intrigante: ¬øfue el Alcalde Malware quien manipul√≥ la situaci√≥n para desviar la atenci√≥n?

---

## üß© Preguntas del Reto (Flags)

Para completar este segundo desaf√≠o del calendario de adviento de TryHackMe, tendr√°s que responder las siguientes preguntas. A continuaci√≥n, te explico c√≥mo puedes encontrar cada respuesta sin dar directamente las soluciones.


#### 1Ô∏è‚É£ **¬øCu√°l es el nombre de la cuenta que caus√≥ todos los intentos fallidos de inicio de sesi√≥n?**

üí° **Pista**: Filtra los resultados por `event.outcome = failure`. La respuesta estar√° en el campo `user.name`.

```cmd
*************
```


#### 2Ô∏è‚É£ **¬øCu√°ntos intentos fallidos de inicio de sesi√≥n fueron observados?**

üí° **Pista**: Filtra los resultados por `event.outcome = failure`. La respuesta estar√° antes de la gr√°fica superior.

```bash
****
```


#### 3Ô∏è‚É£ **¬øCu√°l es la direcci√≥n IP de Glitch?**

üí° **Pista**: Es la que ataca con fuerza bruta y produce el pico de solicitudes.

```bash
**.*.***.*
```


#### 4Ô∏è‚É£ **¬øCu√°ndo Glitch inici√≥ sesi√≥n exitosamente en ADM-01?**

üí° **Pista**: Puedes filtrar por `event.category = authentication` & `event.outcome = success`

```bash
*** *, **** **:**:**.***
```

#### 5Ô∏è‚É£ **¬øCu√°l es el comando decodificado ejecutado por Glitch para arreglar los sistemas de Wareville?**

üí° **Pista**: [Vuelve a leer el paso 4](#paso-4-confirmando-el-ataque-y-decodificando-el-comando)


```bash
********************* ********** ***********
```

---

## üìù Conclusi√≥n

Este ejercicio muestra la importancia de analizar cada alerta con detalle, ya que las apariencias pueden ser enga√±osas. La evidencia es clave para tomar decisiones en un SOC, especialmente en √©pocas de alta presi√≥n.

---

¬°Gracias por participar en este reto! ¬øQu√© opinas de la conclusi√≥n de este caso? ¬øCrees que el Alcalde Malware sigue siendo sospechoso? ¬°D√©janos tus teor√≠as y nos vemos ma√±ana para el pr√≥ximo desaf√≠o!

